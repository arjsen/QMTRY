<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Math MCQ – Quiz</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
  header { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
  .controls { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
  fieldset { margin: 1rem 0; padding: 1rem; border-radius: 8px; border: 1px solid #ddd; }
  legend { font-weight: 600; }
  .choice { display: block; margin: .35rem 0; cursor: pointer; }
  .muted { color: #666; }
  .correct { border-color: #4caf50; background: #f1fbf1; }
  .incorrect { border-color: #f44336; background: #fff4f4; }
  .answer-tag { font-size: .9rem; margin-left: .5rem; }
  button { padding: .6rem .9rem; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; background: #fafafa; }
  button:hover { background: #f3f3f3; }
  .hidden { display: none; }
  .feedback { font-weight: 600; margin-top: .25rem; }
  .feedback.bad { color: #d32f2f; }       /* <50%   */
  .feedback.warn { color: #f57c00; }      /* 50–69% */
  .feedback.ok { color: #1976d2; }        /* 70–79% */
  .feedback.good { color: #2e7d32; }      /* 80–89% */
  .feedback.excellent { color: #2e7d32; font-weight: 700; } /* ≥90% */
</style>

<!-- MathJax: use \( ... \) and \[ ... \] -->
<script>
  window.MathJax = { tex: { inlineMath: [['\\(', '\\)']], displayMath: [['\\[', '\\]']] } };
</script>
<script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <header>
    <h1>Math MCQ – Quiz</h1>
    <div class="controls">
      <a href="index.html">← All tests</a>
      <input type="file" id="fileInput" accept="application/json" />
      <label><input type="checkbox" id="shuffleQs" checked /> Shuffle questions</label>
      <label><input type="checkbox" id="shuffleChoices" checked /> Shuffle choices</label>
      <button id="startBtn" disabled>Start quiz</button>
      <button id="submitBtn" class="hidden">Submit</button>
      <button id="resetBtn" class="hidden">Reset</button>
    </div>
  </header>

  <p id="status" class="muted">Load a test automatically or upload a JSON file.</p>
  <div id="quiz"></div>
  <p id="score"></p>
  <p id="feedback" class="feedback"></p>

  <script>
    const fileInput = document.getElementById('fileInput');
    const startBtn  = document.getElementById('startBtn');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn  = document.getElementById('resetBtn');
    const shuffleQs = document.getElementById('shuffleQs');
    const shuffleChoices = document.getElementById('shuffleChoices');
    const statusEl = document.getElementById('status');
    const quizEl   = document.getElementById('quiz');
    const scoreEl  = document.getElementById('score');
    const feedbackEl = document.getElementById('feedback');

    let originalQuestions = [];
    let questions = [];

    function shuffle(arr){ for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

    function normalizeQuestion(q, idx){
      const id = q.id || `q${idx+1}`;
      let choices = [];
      if (Array.isArray(q.choices) && typeof q.choices[0] === 'string') {
        choices = q.choices.map((text, i) => ({ text, correct: i === q.answer }));
      } else if (Array.isArray(q.choices)) {
        choices = q.choices.map(c => ({ text: c.text, correct: !!c.correct }));
      }
      return { id, question: q.question || '', choices, explanation: q.explanation || '' };
    }

    function renderQuiz(list){
      quizEl.innerHTML = '';
      list.forEach((q, qi) => {
        const fs = document.createElement('fieldset');
        fs.id = `fs-${qi}`;
        const legend = document.createElement('legend');
        legend.innerHTML = `Q${qi+1}. ${q.question}`;
        fs.appendChild(legend);

        const renderedChoices = q.choices.map(c => ({...c}));
        if (shuffleChoices.checked) shuffle(renderedChoices);
        renderedChoices.forEach((c, ci) => {
          const wrap = document.createElement('label'); wrap.className = 'choice';
          const input = document.createElement('input'); input.type='radio'; input.name=`q${qi}`; input.value=ci;
          const txt = document.createElement('span'); txt.innerHTML = ' ' + c.text;
          wrap.appendChild(input); wrap.appendChild(txt); fs.appendChild(wrap);
        });
        fs.dataset.correctRenderedIndex = renderedChoices.findIndex(c => c.correct);

        const expl = document.createElement('div');
        expl.className='muted'; expl.id=`expl-${qi}`; expl.style.display='none';
        expl.innerHTML = q.explanation ? `Explanation: ${q.explanation}` : '';
        fs.appendChild(expl);

        quizEl.appendChild(fs);
      });
      if (window.MathJax?.typesetPromise) MathJax.typesetPromise();
    }

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    const COMMENTS = {
      lt50: ["You need to revise and practice more!","Every expert was once a beginner—let’s rebuild the basics.","Back to fundamentals and you’ll bounce back.","Derivatives are calling for a rematch—game on!"],
      lt70: ["You can improve by revising more!","On the right track—one more review lap.","A few more examples and this will click.","Keep going—consistency beats intensity."],
      lt80: ["Good work!","Solid progress—push a little further to reach 80%+.","Nice! Shore up a couple of concepts.","Good momentum—practice will smooth the edges."],
      lt90: ["Great job—you're close to excellence!","Strong performance; tidy up a few slips for ≥90%.","Almost there—just a small delta from ‘Excellent’.","Very good! A quick review will get you over the line."],
      ge90: ["Excellent work!","Outstanding—your answers converge beautifully.","Brilliant—textbook differentiation.","Superb—keep this gradient going."]
    };

    function grade(){
      let score = 0, total = questions.length;
      questions.forEach((q, qi) => {
        const fs = document.getElementById(`fs-${qi}`);
        const correctIdx = Number(fs.dataset.correctRenderedIndex);
        const sel = document.querySelector(`input[name="q${qi}"]:checked`);
        const chosen = sel ? Number(sel.value) : -1;

        fs.classList.remove('correct','incorrect');
        fs.querySelectorAll('.answer-tag').forEach(n => n.remove());

        const labels = fs.querySelectorAll('.choice');
        if (correctIdx >= 0 && labels[correctIdx]) {
          const tag = document.createElement('span'); tag.className='answer-tag'; tag.textContent='✓ correct';
          labels[correctIdx].appendChild(tag);
        }
        if (chosen === correctIdx) { score++; fs.classList.add('correct'); }
        else {
          fs.classList.add('incorrect');
          if (chosen >= 0 && labels[chosen]) {
            const tag = document.createElement('span'); tag.className='answer-tag'; tag.textContent='✗ your answer';
            labels[chosen].appendChild(tag);
          }
        }
        const expl = document.getElementById(`expl-${qi}`); if (expl && expl.textContent.trim()) expl.style.display='block';
      });

      const percent = Math.round((score/total)*100);
      let msg, cls;
      if (percent < 50)       { msg = pick(COMMENTS.lt50); cls = 'bad'; }
      else if (percent < 70)  { msg = pick(COMMENTS.lt70); cls = 'warn'; }
      else if (percent < 80)  { msg = pick(COMMENTS.lt80); cls = 'ok'; }
      else if (percent < 90)  { msg = pick(COMMENTS.lt90); cls = 'good'; }
      else                    { msg = pick(COMMENTS.ge90); cls = 'excellent'; }
      scoreEl.textContent = `Score: ${score} / ${total} (${percent}%)`;
      feedbackEl.className = `feedback ${cls}`; feedbackEl.textContent = msg;
      if (window.MathJax?.typesetPromise) MathJax.typesetPromise();
    }

    function resetQuiz(){
      quizEl.innerHTML=''; scoreEl.textContent=''; feedbackEl.textContent='';
      feedbackEl.className='feedback'; statusEl.textContent='Load a test automatically or upload a JSON file.';
      startBtn.disabled = !originalQuestions.length;
      submitBtn.classList.add('hidden'); resetBtn.classList.add('hidden');
    }

    // Manual upload (fallback)
    fileInput.addEventListener('change', () => {
      const file = fileInput.files?.[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data) || data.length === 0) throw new Error('JSON must be a non-empty array.');
          originalQuestions = data.map(normalizeQuestion);
          statusEl.textContent = `Loaded ${originalQuestions.length} question(s). Click “Start quiz”.`;
          startBtn.disabled = false;
        } catch (err) {
          originalQuestions = []; startBtn.disabled = true; statusEl.textContent = 'Invalid JSON: ' + err.message;
        }
      };
      reader.readAsText(file);
    });

    // Auto-load by ?test=slug
    async function autoLoad(){
      const slug = new URLSearchParams(location.search).get('test');
      if (!slug) return; // stay in upload mode
      try {
        const res = await fetch(`tests/${slug}.json`);
        if (!res.ok) throw new Error(`Couldn't load tests/${slug}.json`);
        const data = await res.json();
        originalQuestions = data.map(normalizeQuestion);
        statusEl.textContent = `Loaded ${originalQuestions.length} question(s) for “${slug}”. Click “Start quiz”.`;
        startBtn.disabled = false;
        // Optional: hide the manual upload control to avoid confusion
        fileInput.style.display = 'none';
      } catch (e) {
        statusEl.textContent = e.message;
      }
    }
    document.addEventListener('DOMContentLoaded', autoLoad);

    startBtn.addEventListener('click', () => {
      questions = originalQuestions.map(q => ({ id: q.id, question: q.question, choices: q.choices.map(c=>({...c})), explanation: q.explanation }));
      if (shuffleQs.checked) shuffle(questions);
      renderQuiz(questions);
      statusEl.textContent = 'Answer all questions, then click “Submit”.';
      submitBtn.classList.remove('hidden'); resetBtn.classList.remove('hidden');
    });
    submitBtn.addEventListener('click', grade);
    resetBtn.addEventListener('click', resetQuiz);
  </script>
</body>
</html>
