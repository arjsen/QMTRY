<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Math MCQ – Wizard</title>

<!-- ===== light styles ===== -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.min.css">
<style>
:root       { --accent:#0e639c; --bar:#4caf50; }
body        { font-family:system-ui,Arial,sans-serif; margin:0; colour:#222; }
header      { padding:1rem 1rem .5rem; display:flex; align-items:center; gap:.75rem;
              flex-wrap:wrap; border-bottom:1px solid #ddd; }
header h1   { font-size:1.2rem; color:var(--accent); margin:0; }
#progress   { position:relative; width:100%; height:6px; background:#eee; border-radius:3px; overflow:hidden; }
#progress::after{ content:\"\"; position:absolute; inset:0; width:var(--pct,0); background:var(--bar); transition:width .3s; }

main        { max-width:700px; margin:0 auto; padding:1.5rem 1rem; min-height:60vh;
              display:flex; flex-direction:column; gap:1.25rem; }
fieldset    { border:1px solid #ddd; border-radius:12px; padding:1rem 1.25rem; }
legend      { font-weight:600; }
.choice     { display:block; margin:.5rem 0; cursor:pointer; }
.muted      { color:#666; font-size:.9rem; margin-top:.5rem; }
.hidden     { display:none; }

footer      { padding:1rem; display:flex; justify-content:space-between; }
.btn        { padding:.55rem 1.2rem; font-size:1rem; border:1px solid var(--accent);
              background:var(--accent); color:#fff; border-radius:6px; cursor:pointer; }
.btn[disabled]{ opacity:.4; cursor:default; }

.correct    { border-color:#4caf50; background:#f1fbf1; }
.incorrect  { border-color:#f44336; background:#fff4f4; }
.answer-tag { font-size:.85rem; margin-left:.4rem; }

.feedback   { font-weight:600; margin-top:1rem; text-align:center; }
.bad        { color:#d32f2f } .warn{color:#f57c00} .ok{color:#1976d2}
.good       { color:#2e7d32 } .excellent{ color:#2e7d32; font-weight:700 }
</style>

<!-- MathJax -->
<script>
window.MathJax={tex:{inlineMath:[['\\(','\\)']],displayMath:[['\\[','\\]']]}};
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<header>
  <a href="index.html">← All tests</a>
  <h1>Math MCQ</h1>
  <div style="flex:1 1 100%; margin-top:.5rem"><div id="progress"></div></div>
</header>

<main id="stepPane"></main>

<footer>
  <button id="prevBtn" class="btn" disabled>‹ Back</button>
  <button id="nextBtn" class="btn" disabled>Next ›</button>
</footer>

<script>
/* ========== same helper functions from your file (shuffle, normalize, grade) ========== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; }
function normalizeQuestion(q,i){
  const id=q.id||`q${i+1}`;
  let choices=[];
  if(Array.isArray(q.choices)&&typeof q.choices[0]==='string'){
    choices=q.choices.map((t,idx)=>({text:t,correct:idx===q.answer}));
  }else if(Array.isArray(q.choices)){
    choices=q.choices.map(c=>({text:c.text,correct:!!c.correct}));
  }
  return{ id,question:q.question||'',choices,explanation:q.explanation||'' };
}
/* --- comment buckets (same as before) --- */
const COMMENTS={ lt50:["Revise & practice more!"], lt70:["You can improve!"], lt80:["Good work!"], lt90:["Great job!"], ge90:["Excellent work!"] };
function pick(a){return a[Math.floor(Math.random()*a.length)]}

/* ========== DOM refs ========== */
const stepPane=document.getElementById('stepPane'),
      progressBar=document.getElementById('progress'),
      prevBtn=document.getElementById('prevBtn'),
      nextBtn=document.getElementById('nextBtn');

let original=[], questions=[], idx=0, done=false;

/* ========== render one step ========== */
function renderStep(i){
  const q=questions[i];
  stepPane.innerHTML='';
  const fs=document.createElement('fieldset'); fs.id='fs';
  const lg=document.createElement('legend'); lg.innerHTML=`Q${i+1}. ${q.question}`; fs.appendChild(lg);
  q.choices.forEach((c,ci)=>{
    const lbl=document.createElement('label'); lbl.className='choice';
    lbl.innerHTML=`<input type="radio" name="c" value="${ci}"><span> ${c.text}</span>`;
    fs.appendChild(lbl);
  });
  stepPane.appendChild(fs);
  MathJax.typesetPromise();

  /* progress bar */
  progressBar.style.setProperty('--pct',`${Math.round((i)/questions.length*100)}%`);

  /* button states */
  prevBtn.disabled = i===0;
  nextBtn.disabled = false;
  nextBtn.textContent = i===questions.length-1 ? 'Submit' : 'Next ›';
}
/* ========== grade all answers ========== */
function gradeAll(){
  let score=0,total=questions.length;

  stepPane.innerHTML='';                       // clear pane
  questions.forEach((q,qi)=>{
    const fs=document.createElement('fieldset');
    const lg=document.createElement('legend'); lg.textContent=`Q${qi+1}. ${q.question}`; fs.appendChild(lg);

    q.choices.forEach((c,ci)=>{
      const lbl=document.createElement('label'); lbl.className='choice';
      const checked = document.querySelector(`input[data-qi="${qi}"][value="${ci}"]`)?.checked;
      lbl.innerHTML=`<input type="radio" disabled ${checked?'checked':''}><span> ${c.text}</span>`;
      if(c.correct){
        lbl.classList.add('correct');
        lbl.insertAdjacentHTML('beforeend','<span class="answer-tag">✓ correct</span>');
        if(checked) score++;
      }else if(checked){
        lbl.classList.add('incorrect');
        lbl.insertAdjacentHTML('beforeend','<span class="answer-tag">✗ your answer</span>');
      }
      fs.appendChild(lbl);
    });
    /* explanation */
    if(q.explanation){
      const ex=document.createElement('div'); ex.className='muted'; ex.textContent='Explanation: '+q.explanation;
      fs.appendChild(ex);
    }
    stepPane.appendChild(fs);
  });

  /* feedback banner */
  const pct=Math.round(score/total*100);
  let band='ok'; if(pct<50)band='bad'; else if(pct<70)band='warn'; else if(pct<80)band='ok';
  else if(pct<90)band='good'; else band='excellent';
  const fb=document.createElement('p'); fb.className=`feedback ${band}`;
  fb.textContent=`Score ${score}/${total} – ${pct}% – ${pick(COMMENTS[band==='bad'?'lt50':band==='warn'?'lt70':band==='ok'?'lt80':band==='good'?'lt90':'ge90'])}`;
  stepPane.prepend(fb);

  prevBtn.disabled=true; nextBtn.disabled=true;
}

/* ========== attach listeners ========== */
prevBtn.onclick=()=>{ if(idx>0){idx--;renderStep(idx);} };
nextBtn.onclick=()=>{
  if(idx<questions.length-1){
    /* collect answer & move */
    const sel=document.querySelector('input[name="c"]:checked');
    if(!sel){ alert('Please select an answer'); return; }
    sel.dataset.qi=idx;                        // mark answer for grading
    idx++; renderStep(idx);
  }else{
    /* submit */
    const sel=document.querySelector('input[name="c"]:checked');
    if(!sel){ alert('Please select an answer'); return; }
    sel.dataset.qi=idx;
    gradeAll();
  }
};

/* ========== auto-load JSON by ?test=slug ========= */
async function autoLoad(){
  const slug=new URLSearchParams(location.search).get('test');
  if(!slug)return;
  const res=await fetch(`tests/${slug}.json`);
  if(!res.ok){stepPane.textContent='Could not load test.';return;}
  original=await res.json();
  questions=original.map(normalizeQuestion);
  shuffle(questions);                           // optional randomise order
  renderStep(0);
}
document.addEventListener('DOMContentLoaded',autoLoad);
</script>
</body>
</html>
