<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Math MCQ – Wizard</title>

<!-- ===== light styles ===== -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.min.css">
<style>
:root       { --accent:#0e639c; --bar:#4caf50; }
body        { font-family:system-ui,Arial,sans-serif; margin:0; colour:#222; }
header      { padding:1rem 1rem .5rem; display:flex; align-items:center; gap:.75rem;
              flex-wrap:wrap; border-bottom:1px solid #ddd; }
header h1   { font-size:1.2rem; color:var(--accent); margin:0; }
#progress   { position:relative; width:100%; height:6px; background:#eee; border-radius:3px; overflow:hidden; }
#progress::after{ content:\"\"; position:absolute; inset:0; width:var(--pct,0); background:var(--bar); transition:width .3s; }

main        { max-width:700px; margin:0 auto; padding:1.5rem 1rem; min-height:60vh;
              display:flex; flex-direction:column; gap:1.25rem; }
fieldset    { border:1px solid #ddd; border-radius:12px; padding:1rem 1.25rem; }
legend      { font-weight:600; }
.choice     { display:block; margin:.5rem 0; cursor:pointer; }
.muted      { color:#666; font-size:.9rem; margin-top:.5rem; }
.hidden     { display:none; }

footer      { padding:1rem; display:flex; justify-content:space-between; }
.btn        { padding:.55rem 1.2rem; font-size:1rem; border:1px solid var(--accent);
              background:var(--accent); color:#fff; border-radius:6px; cursor:pointer; }
.btn[disabled]{ opacity:.4; cursor:default; }

.correct    { border-color:#4caf50; background:#f1fbf1; }
.incorrect  { border-color:#f44336; background:#fff4f4; }
.answer-tag { font-size:.85rem; margin-left:.4rem; }

.feedback   { font-weight:600; margin-top:1rem; text-align:center; }
.bad        { color:#d32f2f } .warn{color:#f57c00} .ok{color:#1976d2}
.good       { color:#2e7d32 } .excellent{ color:#2e7d32; font-weight:700 }
</style>

<!-- MathJax -->
<script>
/* ---------- helpers (unchanged) ---------- */
function shuffle(a){ for (let i = a.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function normalizeQuestion(q,i){
  const id=q.id||`q${i+1}`;
  let choices=[];
  if (Array.isArray(q.choices) && typeof q.choices[0]==='string'){
    choices=q.choices.map((t,idx)=>({text:t,correct:idx===q.answer}));
  } else if (Array.isArray(q.choices)){
    choices=q.choices.map(c=>({text:c.text,correct:!!c.correct}));
  }
  return {id,question:q.question||'',choices,explanation:q.explanation||''};
}
const COMMENTS={lt50:["Revise & practise more!"],lt70:["You can improve!"],lt80:["Good work!"],lt90:["Great job!"],ge90:["Excellent work!"]};
const pick=a=>a[Math.floor(Math.random()*a.length)];

/* ---------- DOM refs ---------- */
const stepPane=document.getElementById('stepPane'),
      progressBar=document.getElementById('progress'),
      prevBtn=document.getElementById('prevBtn'),
      nextBtn=document.getElementById('nextBtn');

/* ---------- state ---------- */
let questions=[], answers=[], idx=0;

/* ---------- render one question ---------- */
function renderStep(i){
  const q=questions[i];
  stepPane.innerHTML='';
  const fs=document.createElement('fieldset');
  fs.innerHTML=`<legend>Q${i+1}. ${q.question}</legend>`;
  q.choices.forEach((c,ci)=>{
    const lbl=document.createElement('label');
    lbl.className='choice';
    lbl.innerHTML=`<input type="radio" name="choice" value="${ci}"><span> ${c.text}</span>`;
    if(answers[i]===ci) lbl.querySelector('input').checked=true;  // pre-select if already answered
    fs.appendChild(lbl);
  });
  stepPane.appendChild(fs);
  MathJax.typesetPromise();

  /* progress bar */
  const pct = Math.round(i / questions.length * 100) + '%';
  progressBar.style.setProperty('--pct', pct);

  /* buttons */
  prevBtn.disabled = i===0;
  nextBtn.textContent = i===questions.length-1 ? 'Submit' : 'Next ›';
}

/* ---------- grading ---------- */
function gradeAll(){
  let score=0,total=questions.length;
  stepPane.innerHTML='';
  questions.forEach((q,qi)=>{
    if(answers[qi]===q.choices.findIndex(c=>c.correct)) score++;
  });
  const pct=Math.round(score/total*100);
  let band='ok'; if(pct<50)band='bad'; else if(pct<70)band='warn'; else if(pct<80)band='ok';
  else if(pct<90)band='good'; else band='excellent';

  const fb=document.createElement('p');
  fb.className=`feedback ${band}`;
  fb.textContent=`Score ${score}/${total} – ${pct}% – ${pick(COMMENTS[band==='bad'?'lt50':band==='warn'?'lt70':band==='ok'?'lt80':band==='good'?'lt90':'ge90'])}`;
  stepPane.appendChild(fb);

  prevBtn.disabled=true; nextBtn.disabled=true;
  progressBar.style.setProperty('--pct','100%');
}

/* ---------- nav handlers ---------- */
prevBtn.onclick=function(){
  if(idx>0){ idx--; renderStep(idx); }
};
nextBtn.onclick=function(){
  const sel=document.querySelector('input[name="choice"]:checked');
  if(!sel){ alert('Please select an answer'); return; }
  answers[idx]=Number(sel.value);

  if(idx < questions.length-1){
    idx++; renderStep(idx);
  }else{
    gradeAll();
  }
};

/* ---------- load quiz by ?test=slug ---------- */
async function autoLoad(){
  const slug=new URLSearchParams(location.search).get('test');
  if(!slug) return;
  const res=await fetch(`tests/${slug}.json`);
  if(!res.ok){ stepPane.textContent='Could not load test.'; return; }
  questions=(await res.json()).map(normalizeQuestion);
  shuffle(questions);
  answers=new Array(questions.length).fill(null);
  renderStep(0);
}
document.addEventListener('DOMContentLoaded',autoLoad);
</script>

</body>
</html>
